name: Build and push Docker image

on:
  workflow_dispatch:

jobs:
  docker:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Check for UNS update
        run: |
          sudo /bin/sh -c "echo 'deb [ trusted=yes arch=amd64,arm64 ] https://www.ui.com/downloads/unifi/debian stable ubiquiti' > /etc/apt/sources.list.d/100-ubnt-unifi.list"
          sudo apt update
          export repo_version=$(apt info unifi 2>/dev/null | grep '^Version: ' | cut -d' ' -f2)
          export local_version=$(cat current_uns_version)
          if [[ "$repo_version" == "$local_version" ]]
          then
            echo "Already up-to-date with version $local_version" && exit 0
          else
            echo "New version detected.  Current: $local_version. New: $repo_version"
            echo "Continuing with build."
          fi
      
      - name: Setup tmate session
        uses: mxschmitt/action-tmate@v3
        with:
          detached: true
          
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: armhf
          
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/armhf
      
      # - name: Login to Docker Hub
      #   uses: docker/login-action@v3
      #   with:
      #     username: ${{ vars.DOCKERHUB_USERNAME }}
      #     password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          platforms: linux/armhf
          push: false
          tags: agreenbhm/unifi-cloudkey:latest

      - uses: actions/checkout@v3
      - name: Update local version
        run: |
          apt info unifi 2>/dev/null | grep '^Version: ' | cut -d' ' -f2 > current_uns_version
          git config --global user.name 'agreenbhm'
          git config --global user.email 'agreenbhm@users.noreply.github.com'
          git add current_uns_version
          git commit -am "Updated UNS version to $(cat current_uns_version)"
          git push
      

